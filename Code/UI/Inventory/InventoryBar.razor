@using Sandbox.UI

@inherits PanelComponent

<root class="inventory-bar">
    @for (int i = 0; i < 9; i++)
    {
        var slotIndex = i; // Capture loop variable
        var weaponInSlot = GetWeaponForSlot(slotIndex);

        <InventoryIcon TargetCarriable="@weaponInSlot" SlotNumber="@(slotIndex + 1)" @ref="icons[slotIndex]" />
    }
</root>

@code
{
    private Player player;
    private PlayerInventory inventory;
    private BaseCarriable lastActiveWeapon;
    private InventoryIcon[] icons = new InventoryIcon[9];

    protected override void OnUpdate()
    {
        player = Player.FindLocalPlayer();
        if (!player.IsValid())
            return;

        inventory = player?.GetComponent<PlayerInventory>();
        if (!inventory.IsValid())
            return;

        if (inventory.ActiveWeapon is PhysGun physgun && physgun.BeamRenderer.Enabled)
            return;

        // Update active states manually when weapon changes
        if (lastActiveWeapon != inventory.ActiveWeapon)
        {
            lastActiveWeapon = inventory.ActiveWeapon;
            UpdateActiveStates();
        }

        // Handle input for weapon switching
        if (Input.Pressed("slot1")) SetActiveSlot(0);
        if (Input.Pressed("slot2")) SetActiveSlot(1);
        if (Input.Pressed("slot3")) SetActiveSlot(2);
        if (Input.Pressed("slot4")) SetActiveSlot(3);
        if (Input.Pressed("slot5")) SetActiveSlot(4);
        if (Input.Pressed("slot6")) SetActiveSlot(5);
        if (Input.Pressed("slot7")) SetActiveSlot(6);
        if (Input.Pressed("slot8")) SetActiveSlot(7);
        if (Input.Pressed("slot9")) SetActiveSlot(8);

        if (Input.MouseWheel != 0)
        {
            SwitchActiveSlot((int)-Input.MouseWheel.y);
        }
    }

    private void UpdateActiveStates()
    {
        for (int i = 0; i < 9; i++)
        {
            if (icons[i]?.IsValid() == true)
            {
                var weaponInSlot = GetWeaponForSlot(i);
                bool isActive = IsActiveWeapon(weaponInSlot);
                icons[i].SetClass("active", isActive);
            }
        }
    }

    private BaseCarriable GetWeaponForSlot(int slotIndex)
    {
        if (inventory?.Weapons == null) return null;

        var weapons = inventory.Weapons.ToList();
        if (slotIndex < weapons.Count)
        {
            return weapons[slotIndex];
        }

        return null;
    }

    private bool IsActiveWeapon(BaseCarriable weapon)
    {
        return inventory?.ActiveWeapon == weapon && weapon.IsValid();
    }

    private void SetActiveSlot(int slotIndex)
    {
        if (!player.IsValid() || !inventory.IsValid())
            return;

        var weaponInSlot = GetWeaponForSlot(slotIndex);
        if (!weaponInSlot.IsValid())
            return;

        // Don't switch if already active
        if (inventory.ActiveWeapon == weaponInSlot)
            return;

        inventory.SwitchWeapon(weaponInSlot);
    }

    private void SwitchActiveSlot(int delta)
    {
        if (!inventory.IsValid()) return;

        var weapons = inventory.Weapons;
        if (weapons.Count == 0) return;

        int currentIndex = -1;
        if (inventory.ActiveWeapon.IsValid())
        {
            for (int i = 0; i < weapons.Count; i++)
            {
                if (weapons[i] == inventory.ActiveWeapon)
                {
                    currentIndex = i;
                    break;
                }
            }
        }

        int nextIndex = currentIndex + delta;
        while (nextIndex < 0) nextIndex += weapons.Count;
        while (nextIndex >= weapons.Count) nextIndex -= weapons.Count;

        if (nextIndex >= 0 && nextIndex < weapons.Count)
        {
            inventory.SwitchWeapon(weapons[nextIndex]);
        }
    }
}
