@using Sandbox;
@using Sandbox.UI;
@inherits PanelComponent
@implements ILocalPlayerEvent

<root>
	@for (int i = 0; i < 6; i++)
	{
		<InventorySlot Index=@i Inventory=@inventory Hovered=@hovered Active=@active></InventorySlot>
	}
</root>

@code
{
    [Property, Group("Sound")] public SoundEvent SwitchSound { get; set; }
    [Property, Group("Sound")] public SoundEvent SelectSound { get; set; }

    PlayerInventory inventory;
    BaseCarryable hovered;
    BaseCarryable active;
    BaseCarryable prev;

    protected override int BuildHash() => HashCode.Combine(inventory, hovered, active);

    protected override void OnEnabled()
    {
        base.OnEnabled();
        Panel.SetClass("hidden", true);
    }

    void ILocalPlayerEvent.OnPickup(BaseCarryable weapon)
    {
        StateHasChanged();
    }

    protected override void OnUpdate()
    {
        inventory = Game.ActiveScene.GetAllComponents<PlayerInventory>().Where(x => x.Network.IsOwner).FirstOrDefault();
    }

    RealTimeSince timeSinceInteraction;

    public void HandleInputOpen()
    {
        if (hovered is null)
            return;

        if (Input.Pressed("Attack1") || Input.Pressed("Attack2"))
        {
            Input.ReleaseAction("Attack1");
            Input.SetAction("Attack1", false);
            Input.ReleaseAction("Attack2");
            Input.SetAction("Attack2", false);

            prev = inventory.ActiveWeapon;
            inventory.SwitchWeapon(hovered);
            active = hovered;
            hovered = null;
            Panel.Style.Opacity = 0;
            Panel.SetClass("hidden", true);
            Sound.Play(SelectSound);
            return;
        }

        if (timeSinceInteraction > 2.5f)
        {
            hovered = null;
            Panel.SetClass("hidden", true);
            active = null;
            return;
        }

        if (timeSinceInteraction > 1.0f)
        {
            float fadeProgress = (timeSinceInteraction - 1.0f) / 1.5f;
            Panel.Style.Opacity = 1f - fadeProgress;
        }
    }

    public void HandleInput()
    {
        if (inventory is null)
            return;

        MoveSlot(-(int)Input.MouseWheel.y);

        if ( Input.Pressed( "invprev" ) && prev.IsValid() )
        {
            var weapon = prev;
            prev = inventory.ActiveWeapon;
            inventory.SwitchWeapon( weapon );
        }

        if (Input.Pressed("Slot1")) IterateSlot(0);
        if (Input.Pressed("Slot2")) IterateSlot(1);
        if (Input.Pressed("Slot3")) IterateSlot(2);
        if (Input.Pressed("Slot4")) IterateSlot(3);
        if (Input.Pressed("Slot5")) IterateSlot(4);
        if (Input.Pressed("Slot6")) IterateSlot(5);
    }

    public void MoveSlot( int delta )
    {
        if ( delta == 0 )
            return;

        var weapons = inventory.Weapons.Where( x => x.CanSwitch() ).ToList();

        if ( weapons.Count == 0 )
            return;

        var currentHover = hovered ?? active ?? inventory.ActiveWeapon ?? weapons.FirstOrDefault();

        int currentIndex = weapons.IndexOf( currentHover );

        currentIndex += delta;
        currentIndex %= weapons.Count;
        if ( currentIndex < 0 )
            currentIndex = weapons.Count + currentIndex;

        active = null;
        if ( GamePreferences.FastSwitch )
        {
            inventory.SwitchWeapon( weapons[currentIndex] );
        }
        else
        {
            hovered = weapons[currentIndex];
            timeSinceInteraction = 0;
            Panel.Style.Opacity = 1;
            Panel.SetClass("hidden", false);
        }

        Sound.Play(SwitchSound);
	}

	public void IterateSlot( int slot )
	{
		var slotWeapons = inventory.Weapons.Where( x => x.InventorySlot == slot ).Where( x => x.CanSwitch() ).OrderBy( x => x.InventoryOrder ).ToList();
		if ( slotWeapons.Count == 0 )
			return;

		var currentHover = hovered ?? active;
		var activeWeapon = inventory.ActiveWeapon;

		int currentIndex = -1;

		if ( currentHover != null && currentHover.InventorySlot == slot )
		{
			currentIndex = slotWeapons.IndexOf( currentHover );
		}
		else if ( activeWeapon != null && activeWeapon.InventorySlot == slot )
		{
			currentIndex = slotWeapons.IndexOf( activeWeapon );
		}

		currentIndex += 1;
		currentIndex %= slotWeapons.Count;

		active = null;
		if ( GamePreferences.FastSwitch )
		{
			inventory.SwitchWeapon( slotWeapons[currentIndex] );
		}
		else
		{
			hovered = slotWeapons[currentIndex];
			timeSinceInteraction = 0;
			Panel.Style.Opacity = 1;
			Panel.SetClass("hidden", false);
		}

        Sound.Play(SwitchSound);
    }
}
