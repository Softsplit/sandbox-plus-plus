@using Sandbox;
@using Sandbox.UI;
@inherits PanelComponent
@implements Component.INetworkListener

<root>
    <div class="chat_wrapper">
        <div class="container">
            <div class="filters_button" onclick="@ToggleFilters">Filters</div>

            <div class="output" @ref="OutputPanel">
                @foreach (var entry in Entries)
                {
                    var opacity = isOpen ? 1.0f : GetMessageOpacity(entry.timeSinceAdded);
                    <div class="chat_entry" style="opacity: @opacity">
                        @if (!string.IsNullOrEmpty(entry.author))
                        {
                            <span class="author" style="color: @entry.color">@entry.author:</span> <span class="message">@entry.message</span>
                        }
                        else
                        {
                            <span class="message" style="color: @entry.color">@entry.message</span>
                        }
                    </div>
                }
            </div>

            <div class="input">
                <span class="prefix">Say :</span>
                <TextEntry @ref="InputBox" onsubmit="@ChatFinished" MaxLength="@(128)"></TextEntry>
            </div>
        </div>

        <div class="filters_panel" @ref="FiltersPanel">
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.JoinLeave))"><div class="checkbox" @ref="CheckboxJoinLeave">check</div><div class="filter_label">Joins/Leaves</div></div>
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.NameChange))"><div class="checkbox" @ref="CheckboxNameChange">check</div><div class="filter_label">Name Changes</div></div>
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.PublicChat))"><div class="checkbox" @ref="CheckboxPublicChat">check</div><div class="filter_label">Public Chat</div></div>
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.ServerMessage))"><div class="checkbox" @ref="CheckboxServerMessage">check</div><div class="filter_label">Server Messages</div></div>
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.TeamChange))"><div class="checkbox" @ref="CheckboxTeamChange">check</div><div class="filter_label">Team Changes</div></div>
            <div class="filter_row" onclick="@(() => ToggleFilter(ChatFilter.Achievement))"><div class="checkbox" @ref="CheckboxAchievement">check</div><div class="filter_label">Achievement Announce</div></div>
        </div>
    </div>
</root>

@code
{
    [Flags]
    public enum ChatFilter
    {
        None          = 0,
        JoinLeave     = 0x01,
        NameChange    = 0x02,
        PublicChat    = 0x04,
        ServerMessage = 0x08,
        TeamChange    = 0x10,
        Achievement   = 0x20,
        All           = 0x3F
    }

    TextEntry InputBox;
    Panel OutputPanel;
    Panel FiltersPanel;
    Panel CheckboxJoinLeave;
    Panel CheckboxNameChange;
    Panel CheckboxPublicChat;
    Panel CheckboxServerMessage;
    Panel CheckboxTeamChange;
    Panel CheckboxAchievement;

    bool isOpen;
    bool filtersOpen;
    int scrollDelayFrames;
    const int ScrollDelayFrameCount = 2;

    ChatFilter FilterFlags = ChatFilter.All;

    public record Entry(ulong SteamId, string author, string message, string color, RealTimeSince timeSinceAdded, ChatFilter filter);
    List<Entry> Entries = new();

    void ToggleFilters()
    {
        filtersOpen = !filtersOpen;
        FiltersPanel?.SetClass("visible", filtersOpen);
    }

    void ToggleFilter(ChatFilter flag)
    {
        FilterFlags ^= flag;
        UpdateCheckboxStates();
    }

    bool HasFilter(ChatFilter flag) => (FilterFlags & flag) != 0;

    void UpdateCheckboxStates()
    {
        CheckboxJoinLeave?.SetClass("checked", HasFilter(ChatFilter.JoinLeave));
        CheckboxNameChange?.SetClass("checked", HasFilter(ChatFilter.NameChange));
        CheckboxPublicChat?.SetClass("checked", HasFilter(ChatFilter.PublicChat));
        CheckboxServerMessage?.SetClass("checked", HasFilter(ChatFilter.ServerMessage));
        CheckboxTeamChange?.SetClass("checked", HasFilter(ChatFilter.TeamChange));
        CheckboxAchievement?.SetClass("checked", HasFilter(ChatFilter.Achievement));
    }

    protected override void OnUpdate()
    {
        if (InputBox is null)
            return;

        Panel.AcceptsFocus = false;
        UpdateCheckboxStates();

        if (Input.Pressed("chat") && !isOpen)
        {
            isOpen = true;
            InputBox.Focus();
        }

        if (Input.Pressed("menu") && isOpen)
        {
            CloseChat();

            Input.Suppressed = false;
        }

        if (isOpen)
        {
            if (!InputBox.HasFocus)
            {
                InputBox.Focus();
            }

            Input.Suppressed = true;
        }

        SetClass("open", isOpen);

        if (scrollDelayFrames > 0)
        {
            scrollDelayFrames--;
            if (scrollDelayFrames == 0 && OutputPanel is not null)
            {
                OutputPanel.ScrollOffset = new Vector2(0, OutputPanel.ScrollSize.y);
            }
        }

        StateHasChanged();
    }

    void CloseChat()
    {
        isOpen = false;
        filtersOpen = false;
        FiltersPanel?.SetClass("visible", false);
        InputBox?.Blur();
    }

    void ChatFinished()
    {
        var text = InputBox.Text;
        InputBox.Text = "";

        if (!string.IsNullOrWhiteSpace(text))
        {
            if (text.Contains("birmingham", StringComparison.OrdinalIgnoreCase))
            {
                Sandbox.Services.Achievements.Unlock("secret_phrase");
            }

            AddText(text);
        }

        CloseChat();
    }

    [ConCmd("say")]
    private static void Say(string msg)
    {
        var chat = Game.ActiveScene.GetAll<Chat>().FirstOrDefault();

        if (Application.IsDedicatedServer)
        {
            chat?.AddSystemMessage(msg);
        }
        else
        {
            chat?.AddText(msg);
        }
    }

    [Rpc.Broadcast]
    public void AddText(string message)
    {
        message = message.Truncate(128);

        if (string.IsNullOrWhiteSpace(message))
            return;

        if (!HasFilter(ChatFilter.PublicChat))
            return;

        var author = Rpc.Caller.DisplayName;
        var steamid = Rpc.Caller.SteamId;

        Log.Info($"{author}: {message}");

        Entries.Add(new Entry(steamid, author, message, "#ffff64", 0f, ChatFilter.PublicChat));
        scrollDelayFrames = ScrollDelayFrameCount;
        StateHasChanged();
    }

    [Rpc.Broadcast]
    public void AddSystemMessage(string message, ChatFilter filter = ChatFilter.ServerMessage)
    {
        message = message.Truncate(128);

        if (string.IsNullOrWhiteSpace(message))
            return;

        if (!HasFilter(filter))
            return;

        Entries.Add(new Entry(0, "", message, "#99ccff", 0f, filter));
        scrollDelayFrames = ScrollDelayFrameCount;
        StateHasChanged();
    }

    float GetMessageOpacity(float timeSinceAdded)
    {
        const float displayTime = 12f;
        const float fadeTime = 2f;

        if (timeSinceAdded < displayTime)
            return 1f;

        if (timeSinceAdded < displayTime + fadeTime)
            return 1f - (timeSinceAdded - displayTime) / fadeTime;

        return 0f;
    }

    void Component.INetworkListener.OnConnected(Connection channel)
    {
        if (IsProxy) return;
        AddSystemMessage($"{channel.DisplayName} has joined the game", ChatFilter.JoinLeave);
    }

    void Component.INetworkListener.OnDisconnected(Connection channel)
    {
        if (IsProxy) return;
        AddSystemMessage($"{channel.DisplayName} has left the game", ChatFilter.JoinLeave);
    }
}
